<!doctype html><html lang=en dir=auto><head><meta charset=utf-8><meta http-equiv=X-UA-Compatible content="IE=edge"><meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no"><meta name=robots content="index, follow"><title>vps 登录推送 | johnpoint's blog</title>
<meta name=keywords content="vps,安全"><meta name=description content="国内的云服务器大多数都自带了 ssh 登录提示功能，这个功能我觉得不错，但是在很多并没有深度定制系统镜像的云服务器服务商那里就没有远程登录提醒功能了，于是写了一个小脚本来实现远程登录就将登录信息推送至 telegram 的功能
文件名 00-ssh-login-alarm-telegram.sh (其实也可以自己自定义)，将文件放在 /etc/profile.d 目录下。
#!/bin/bash #填入 telegram bot 的 token token= #填自己telegram的id id= #vps ip vpsip=$(curl -s ip.sb -4) #登录时间 logintime=$(TZ=UTC-8 date '+%Y-%m-%d %H:%M:%S') #远程登录的ip loginip=$(who -u am i 2>/dev/null| awk '{print $NF}'|sed -e 's/[()]//g') #ip归属asn组织名称 loginfrom=$(curl -s https://api.ip.sb/geoip/${loginip} | jq .asn_organization) curl -s &#34;https://api.telegram.org/bot${token}/sendMessage?chat_id=${id}&#34; --data-binary &#34;&amp;text=NewLogin:%0AVPS: ${vpsip}%0ATime: ${logintime}%0ALogin from:%0A${loginip}%0A${loginfrom}&#34; > /dev/null 因为用到了 jq 作为解析 json 的工具，所以需要在包管理器中自行安装。
使用效果：
NewLogin: VPS: ***.***.***.*** Time: 2020-09-13 12:41:24 Login from: ***."><meta name=author content="johnpoint"><link rel=canonical href=https://blog.lvcshu.com/2020/09/13/vps-%E7%99%BB%E5%BD%95%E6%8E%A8%E9%80%81/><link crossorigin=anonymous href=/assets/css/stylesheet.9a07b9c81cbc95fa741d61ca6489dcdb8491591c19dca31d14a124a4ba95ec80.css integrity="sha256-mge5yBy8lfp0HWHKZInc24SRWRwZ3KMdFKEkpLqV7IA=" rel="preload stylesheet" as=style><script defer crossorigin=anonymous src=/assets/js/highlight.f413e19d0714851f6474e7ee9632408e58ac146fbdbe62747134bea2fa3415e0.js integrity="sha256-9BPhnQcUhR9kdOfuljJAjlisFG+9vmJ0cTS+ovo0FeA=" onload=hljs.initHighlightingOnLoad()></script><link rel=icon href=https://blog.lvcshu.com/favicon.ico><link rel=icon type=image/png sizes=16x16 href=https://blog.lvcshu.com/favicon.ico><link rel=icon type=image/png sizes=32x32 href=https://blog.lvcshu.com/favicon.ico><link rel=apple-touch-icon href=https://blog.lvcshu.com/favicon.ico><link rel=mask-icon href=https://blog.lvcshu.com/favicon.ico><meta name=theme-color content="#2e2e33"><meta name=msapplication-TileColor content="#2e2e33"><link rel=alternate hreflang=en href=https://blog.lvcshu.com/2020/09/13/vps-%E7%99%BB%E5%BD%95%E6%8E%A8%E9%80%81/><noscript><style>#theme-toggle,.top-link{display:none}</style></noscript><meta property="og:title" content="vps 登录推送"><meta property="og:description" content="国内的云服务器大多数都自带了 ssh 登录提示功能，这个功能我觉得不错，但是在很多并没有深度定制系统镜像的云服务器服务商那里就没有远程登录提醒功能了，于是写了一个小脚本来实现远程登录就将登录信息推送至 telegram 的功能
文件名 00-ssh-login-alarm-telegram.sh (其实也可以自己自定义)，将文件放在 /etc/profile.d 目录下。
#!/bin/bash #填入 telegram bot 的 token token= #填自己telegram的id id= #vps ip vpsip=$(curl -s ip.sb -4) #登录时间 logintime=$(TZ=UTC-8 date '+%Y-%m-%d %H:%M:%S') #远程登录的ip loginip=$(who -u am i 2>/dev/null| awk '{print $NF}'|sed -e 's/[()]//g') #ip归属asn组织名称 loginfrom=$(curl -s https://api.ip.sb/geoip/${loginip} | jq .asn_organization) curl -s &#34;https://api.telegram.org/bot${token}/sendMessage?chat_id=${id}&#34; --data-binary &#34;&amp;text=NewLogin:%0AVPS: ${vpsip}%0ATime: ${logintime}%0ALogin from:%0A${loginip}%0A${loginfrom}&#34; > /dev/null 因为用到了 jq 作为解析 json 的工具，所以需要在包管理器中自行安装。
使用效果：
NewLogin: VPS: ***.***.***.*** Time: 2020-09-13 12:41:24 Login from: ***."><meta property="og:type" content="article"><meta property="og:url" content="https://blog.lvcshu.com/2020/09/13/vps-%E7%99%BB%E5%BD%95%E6%8E%A8%E9%80%81/"><meta property="article:section" content="posts"><meta property="article:published_time" content="2020-09-13T13:10:21+08:00"><meta property="article:modified_time" content="2020-09-13T13:10:21+08:00"><meta property="og:site_name" content="johnpoint's blog"><meta name=twitter:card content="summary"><meta name=twitter:title content="vps 登录推送"><meta name=twitter:description content="国内的云服务器大多数都自带了 ssh 登录提示功能，这个功能我觉得不错，但是在很多并没有深度定制系统镜像的云服务器服务商那里就没有远程登录提醒功能了，于是写了一个小脚本来实现远程登录就将登录信息推送至 telegram 的功能
文件名 00-ssh-login-alarm-telegram.sh (其实也可以自己自定义)，将文件放在 /etc/profile.d 目录下。
#!/bin/bash #填入 telegram bot 的 token token= #填自己telegram的id id= #vps ip vpsip=$(curl -s ip.sb -4) #登录时间 logintime=$(TZ=UTC-8 date '+%Y-%m-%d %H:%M:%S') #远程登录的ip loginip=$(who -u am i 2>/dev/null| awk '{print $NF}'|sed -e 's/[()]//g') #ip归属asn组织名称 loginfrom=$(curl -s https://api.ip.sb/geoip/${loginip} | jq .asn_organization) curl -s &#34;https://api.telegram.org/bot${token}/sendMessage?chat_id=${id}&#34; --data-binary &#34;&amp;text=NewLogin:%0AVPS: ${vpsip}%0ATime: ${logintime}%0ALogin from:%0A${loginip}%0A${loginfrom}&#34; > /dev/null 因为用到了 jq 作为解析 json 的工具，所以需要在包管理器中自行安装。
使用效果：
NewLogin: VPS: ***.***.***.*** Time: 2020-09-13 12:41:24 Login from: ***."><script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Posts","item":"https://blog.lvcshu.com/posts/"},{"@type":"ListItem","position":2,"name":"vps 登录推送","item":"https://blog.lvcshu.com/2020/09/13/vps-%E7%99%BB%E5%BD%95%E6%8E%A8%E9%80%81/"}]}</script><script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"vps 登录推送","name":"vps 登录推送","description":"国内的云服务器大多数都自带了 ssh 登录提示功能，这个功能我觉得不错，但是在很多并没有深度定制系统镜像的云服务器服务商那里就没有远程登录提醒功能了，于是写了一个小脚本来实现远程登录就将登录信息推送至 telegram 的功能\n文件名 00-ssh-login-alarm-telegram.sh (其实也可以自己自定义)，将文件放在 /etc/profile.d 目录下。\n#!/bin/bash #填入 telegram bot 的 token token= #填自己telegram的id id= #vps ip vpsip=$(curl -s ip.sb -4) #登录时间 logintime=$(TZ=UTC-8 date \u0026#39;+%Y-%m-%d %H:%M:%S\u0026#39;) #远程登录的ip loginip=$(who -u am i 2\u0026gt;/dev/null| awk \u0026#39;{print $NF}\u0026#39;|sed -e \u0026#39;s/[()]//g\u0026#39;) #ip归属asn组织名称 loginfrom=$(curl -s https://api.ip.sb/geoip/${loginip} | jq .asn_organization) curl -s \u0026#34;https://api.telegram.org/bot${token}/sendMessage?chat_id=${id}\u0026#34; --data-binary \u0026#34;\u0026amp;text=NewLogin:%0AVPS: ${vpsip}%0ATime: ${logintime}%0ALogin from:%0A${loginip}%0A${loginfrom}\u0026#34; \u0026gt; /dev/null 因为用到了 jq 作为解析 json 的工具，所以需要在包管理器中自行安装。\n使用效果：\nNewLogin: VPS: ***.***.***.*** Time: 2020-09-13 12:41:24 Login from: ***.","keywords":["vps","安全"],"articleBody":"国内的云服务器大多数都自带了 ssh 登录提示功能，这个功能我觉得不错，但是在很多并没有深度定制系统镜像的云服务器服务商那里就没有远程登录提醒功能了，于是写了一个小脚本来实现远程登录就将登录信息推送至 telegram 的功能\n文件名 00-ssh-login-alarm-telegram.sh (其实也可以自己自定义)，将文件放在 /etc/profile.d 目录下。\n#!/bin/bash #填入 telegram bot 的 token token= #填自己telegram的id id= #vps ip vpsip=$(curl -s ip.sb -4) #登录时间 logintime=$(TZ=UTC-8 date '+%Y-%m-%d %H:%M:%S') #远程登录的ip loginip=$(who -u am i 2\u003e/dev/null| awk '{print $NF}'|sed -e 's/[()]//g') #ip归属asn组织名称 loginfrom=$(curl -s https://api.ip.sb/geoip/${loginip} | jq .asn_organization) curl -s \"https://api.telegram.org/bot${token}/sendMessage?chat_id=${id}\" --data-binary \"\u0026text=NewLogin:%0AVPS: ${vpsip}%0ATime: ${logintime}%0ALogin from:%0A${loginip}%0A${loginfrom}\" \u003e /dev/null 因为用到了 jq 作为解析 json 的工具，所以需要在包管理器中自行安装。\n使用效果：\nNewLogin: VPS: ***.***.***.*** Time: 2020-09-13 12:41:24 Login from: ***.***.***.*** \"asn_organization\" 脚本使用的 api 来自 ip.sb\n2021-10-20 更新 脚本中间更新了几个版本，现在的脚本已经可以实现之前所缺少的一些功能\n显示登录用户名 不阻塞登录用户的 TTY #!/bin/bash #填入 telegram bot 的 token token= #填自己telegram的id id= localip=$(who -u am i 2\u003e/dev/null| awk '{print $NF}'|sed -e 's/[()]//g') echo 'localip=$(curl -s ip.sb -4)' \u003e tg.sh echo 'user=$(whoami)' \u003e\u003e tg.sh echo 'logintime=$(TZ=UTC-8 date \"+%Y-%m-%d %H:%M:%S\")' \u003e\u003e tg.sh echo 'loginip='${localip} \u003e\u003e tg.sh echo 'loginfrom=$(curl -s https://api.ip.sb/geoip/${loginip} | jq -r .asn_organization)' \u003e\u003e tg.sh echo 'curl -s \"https://api.telegram.org/bot'${token}'/sendMessage?chat_id='${id}'\" --data-binary \"\u0026text=NewLogin:%0AVPS:${user}@${localip}%0ATime: ${logintime}%0ALogin from:%0A${loginip}%0A${loginfrom}\" \u003e /dev/null \u0026\u0026 rm tg.sh' \u003e\u003e tg.sh bash tg.sh \u0026 ","wordCount":"153","inLanguage":"en","datePublished":"2020-09-13T13:10:21+08:00","dateModified":"2020-09-13T13:10:21+08:00","author":{"@type":"Person","name":"johnpoint"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://blog.lvcshu.com/2020/09/13/vps-%E7%99%BB%E5%BD%95%E6%8E%A8%E9%80%81/"},"publisher":{"@type":"Organization","name":"johnpoint's blog","logo":{"@type":"ImageObject","url":"https://blog.lvcshu.com/favicon.ico"}}}</script></head><body class=dark id=top><header class=header><nav class=nav><div class=logo><a href=https://blog.lvcshu.com/ accesskey=h title="johnpoint's blog (Alt + H)">johnpoint's blog</a><div class=logo-switches><ul class=lang-switch><li>|</li></ul></div></div><ul id=menu><li><a href=https://blog.lvcshu.com/posts/ title=归档><span>归档</span></a></li><li><a href=https://blog.lvcshu.com/friends/ title=友链><span>友链</span></a></li><li><a href=https://blog.lvcshu.com/about/ title=关于我><span>关于我</span></a></li><li><a href=https://blog.lvcshu.com/search/ title="搜索 (Alt + /)" accesskey=/><span>搜索</span></a></li></ul></nav></header><main class=main><article class=post-single><header class=post-header><h1 class="post-title entry-hint-parent">vps 登录推送</h1><div class=post-meta><span title='2020-09-13 13:10:21 +0800 CST'>2020-09-13 13:10:21</span>&nbsp;·&nbsp;1 min&nbsp;·&nbsp;153 words&nbsp;·&nbsp;johnpoint</div></header><div class=post-content><p>国内的云服务器大多数都自带了 ssh 登录提示功能，这个功能我觉得不错，但是在很多并没有深度定制系统镜像的云服务器服务商那里就没有远程登录提醒功能了，于是写了一个小脚本来实现远程登录就将登录信息推送至 telegram 的功能</p><p>文件名 <code>00-ssh-login-alarm-telegram.sh</code> (其实也可以自己自定义)，将文件放在 <code>/etc/profile.d</code> 目录下。</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-bash data-lang=bash><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1>#填入 telegram bot 的 token</span>
</span></span><span class=line><span class=cl><span class=nv>token</span><span class=o>=</span>
</span></span><span class=line><span class=cl><span class=c1>#填自己telegram的id</span>
</span></span><span class=line><span class=cl><span class=nv>id</span><span class=o>=</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>#vps ip</span>
</span></span><span class=line><span class=cl><span class=nv>vpsip</span><span class=o>=</span><span class=k>$(</span>curl -s ip.sb -4<span class=k>)</span>
</span></span><span class=line><span class=cl><span class=c1>#登录时间</span>
</span></span><span class=line><span class=cl><span class=nv>logintime</span><span class=o>=</span><span class=k>$(</span><span class=nv>TZ</span><span class=o>=</span>UTC-8 date <span class=s1>&#39;+%Y-%m-%d %H:%M:%S&#39;</span><span class=k>)</span>
</span></span><span class=line><span class=cl><span class=c1>#远程登录的ip</span>
</span></span><span class=line><span class=cl><span class=nv>loginip</span><span class=o>=</span><span class=k>$(</span>who -u am i 2&gt;/dev/null<span class=p>|</span> awk <span class=s1>&#39;{print $NF}&#39;</span><span class=p>|</span>sed -e <span class=s1>&#39;s/[()]//g&#39;</span><span class=k>)</span>
</span></span><span class=line><span class=cl><span class=c1>#ip归属asn组织名称</span>
</span></span><span class=line><span class=cl><span class=nv>loginfrom</span><span class=o>=</span><span class=k>$(</span>curl -s https://api.ip.sb/geoip/<span class=si>${</span><span class=nv>loginip</span><span class=si>}</span> <span class=p>|</span> jq .asn_organization<span class=k>)</span>
</span></span><span class=line><span class=cl>curl -s <span class=s2>&#34;https://api.telegram.org/bot</span><span class=si>${</span><span class=nv>token</span><span class=si>}</span><span class=s2>/sendMessage?chat_id=</span><span class=si>${</span><span class=nv>id</span><span class=si>}</span><span class=s2>&#34;</span> --data-binary <span class=s2>&#34;&amp;text=NewLogin:%0AVPS: </span><span class=si>${</span><span class=nv>vpsip</span><span class=si>}</span><span class=s2>%0ATime: </span><span class=si>${</span><span class=nv>logintime</span><span class=si>}</span><span class=s2>%0ALogin from:%0A</span><span class=si>${</span><span class=nv>loginip</span><span class=si>}</span><span class=s2>%0A</span><span class=si>${</span><span class=nv>loginfrom</span><span class=si>}</span><span class=s2>&#34;</span> &gt; /dev/null
</span></span></code></pre></div><p>因为用到了 <code>jq</code> 作为解析 json 的工具，所以需要在包管理器中自行安装。</p><p>使用效果：</p><div class=highlight><pre tabindex=0 class=chroma><code class=language-fallback data-lang=fallback><span class=line><span class=cl>NewLogin:
</span></span><span class=line><span class=cl>VPS: ***.***.***.***
</span></span><span class=line><span class=cl>Time: 2020-09-13 12:41:24
</span></span><span class=line><span class=cl>Login from:
</span></span><span class=line><span class=cl>***.***.***.***
</span></span><span class=line><span class=cl>&#34;asn_organization&#34;
</span></span></code></pre></div><p><em>脚本使用的 api 来自 ip.sb</em></p><h3 id=2021-10-20-更新>2021-10-20 更新<a hidden class=anchor aria-hidden=true href=#2021-10-20-更新>#</a></h3><p>脚本中间更新了几个版本，现在的脚本已经可以实现之前所缺少的一些功能</p><ul><li>显示登录用户名</li><li>不阻塞登录用户的 TTY</li></ul><div class=highlight><pre tabindex=0 class=chroma><code class=language-shell data-lang=shell><span class=line><span class=cl><span class=cp>#!/bin/bash
</span></span></span><span class=line><span class=cl><span class=cp></span>
</span></span><span class=line><span class=cl><span class=c1>#填入 telegram bot 的 token</span>
</span></span><span class=line><span class=cl><span class=nv>token</span><span class=o>=</span>
</span></span><span class=line><span class=cl><span class=c1>#填自己telegram的id</span>
</span></span><span class=line><span class=cl><span class=nv>id</span><span class=o>=</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nv>localip</span><span class=o>=</span><span class=k>$(</span>who -u am i 2&gt;/dev/null<span class=p>|</span> awk <span class=s1>&#39;{print $NF}&#39;</span><span class=p>|</span>sed -e <span class=s1>&#39;s/[()]//g&#39;</span><span class=k>)</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s1>&#39;localip=$(curl -s ip.sb -4)&#39;</span> &gt; tg.sh
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s1>&#39;user=$(whoami)&#39;</span> &gt;&gt; tg.sh
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s1>&#39;logintime=$(TZ=UTC-8 date &#34;+%Y-%m-%d %H:%M:%S&#34;)&#39;</span> &gt;&gt; tg.sh
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s1>&#39;loginip=&#39;</span><span class=si>${</span><span class=nv>localip</span><span class=si>}</span> &gt;&gt; tg.sh
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s1>&#39;loginfrom=$(curl -s https://api.ip.sb/geoip/${loginip} | jq -r .asn_organization)&#39;</span> &gt;&gt; tg.sh
</span></span><span class=line><span class=cl><span class=nb>echo</span> <span class=s1>&#39;curl -s &#34;https://api.telegram.org/bot&#39;</span><span class=si>${</span><span class=nv>token</span><span class=si>}</span><span class=s1>&#39;/sendMessage?chat_id=&#39;</span><span class=si>${</span><span class=nv>id</span><span class=si>}</span><span class=s1>&#39;&#34; --data-binary &#34;&amp;text=NewLogin:%0AVPS:${user}@${localip}%0ATime: ${logintime}%0ALogin from:%0A${loginip}%0A${loginfrom}&#34; &gt; /dev/null &amp;&amp; rm tg.sh&#39;</span> &gt;&gt; tg.sh
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl>bash tg.sh <span class=p>&amp;</span>
</span></span></code></pre></div></div><footer class=post-footer><ul class=post-tags><li><a href=https://blog.lvcshu.com/tags/vps/>Vps</a></li><li><a href=https://blog.lvcshu.com/tags/%E5%AE%89%E5%85%A8/>安全</a></li></ul><nav class=paginav><a class=prev href=https://blog.lvcshu.com/2020/10/09/upgrade-to-python-3.9/><span class=title>« Prev</span><br><span>编译安装 python 3.9</span>
</a><a class=next href=https://blog.lvcshu.com/2020/06/13/liunx-jetbrains-%E8%BD%AF%E4%BB%B6%E8%BE%93%E5%85%A5%E4%B8%AD%E6%96%87/><span class=title>Next »</span><br><span>liunx jetbrains 软件输入中文</span></a></nav><div id=disqus_thread></div><script>(function(){var e=document,t=e.createElement("script");t.src="https://johnpoints-blog-hexo.disqus.com/embed.js",t.setAttribute("data-timestamp",+new Date),(e.head||e.body).appendChild(t)})()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript></footer></article></main><footer class=footer><span>&copy; 2024 <a href=https://blog.lvcshu.com/>johnpoint's blog</a></span>
<span>Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://github.com/adityatelange/hugo-PaperMod/ rel=noopener target=_blank>PaperMod</a></span></footer><a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a><script>let menu=document.getElementById("menu");menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(e=>{e.addEventListener("click",function(e){e.preventDefault();var t=this.getAttribute("href").substr(1);window.matchMedia("(prefers-reduced-motion: reduce)").matches?document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(t)}']`).scrollIntoView({behavior:"smooth"}),t==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${t}`)})})</script><script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script><script>document.querySelectorAll("pre > code").forEach(e=>{const n=e.parentNode.parentNode,t=document.createElement("button");t.classList.add("copy-code"),t.innerHTML="copy";function s(){t.innerHTML="copied!",setTimeout(()=>{t.innerHTML="copy"},2e3)}t.addEventListener("click",t=>{if("clipboard"in navigator){navigator.clipboard.writeText(e.textContent),s();return}const n=document.createRange();n.selectNodeContents(e);const o=window.getSelection();o.removeAllRanges(),o.addRange(n);try{document.execCommand("copy"),s()}catch{}o.removeRange(n)}),n.classList.contains("highlight")?n.appendChild(t):n.parentNode.firstChild==n||(e.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?e.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(t):e.parentNode.appendChild(t))})</script><script async src=https://umami.uipo.cc/script.js data-website-id=7319ce07-a672-4d99-bf07-9ebb227d449d></script></body></html>